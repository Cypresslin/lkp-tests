pkgname=xfstests
pkgver=git
pkgrel=1
url='https://git.kernel.org/pub/scm/fs/xfs/xfstests-dev.git'
arch=('i386' 'x86_64' 'aarch64')
license=('GPL')
source=('https://git.kernel.org/pub/scm/fs/xfs/xfstests-dev.git' 'https://git.kernel.org/pub/scm/linux/kernel/git/jaegeuk/f2fs-tools.git' 'https://git.kernel.org/pub/scm/linux/kernel/git/djwong/e2fsprogs.git')
md5sums=('SKIP' 'SKIP' 'SKIP')

. $LKP_SRC/lib/tests/common.sh
. $LKP_SRC/lib/install.sh

build_install_xfstests()
{
	cd ${srcdir}/xfstests-dev || return

	# new tests will be added continuously and lead to new groups to split them.
	# print current head commit so we can check whether a specific test was introduced at the moment.
	git log --oneline -n1

	## Currently, ./configure file can't work with "--prefix" option correctly,
	## so we just use the "make" command to generate the execuable file.
	make
}

build_install_f2fs_tools()
{
	cd ${srcdir}/f2fs-tools || return
	./autogen.sh || return
	./configure || return
	make || return
	make install || return
	make install DESTDIR="${pkgdir}"
}

build_install_e2fuzz()
{
	cd ${srcdir}/e2fsprogs || return
	./configure || return
	make || return
	cp misc/e2fuzz ${pkgdir}/usr/local/sbin/
}

# Automatically generate ignore file to skip test cases which can not be enabled at present.
generate_exclude_files()
{
	benchmark_path="${pkgdir}/lkp/benchmarks/${pkgname}"

	mkdir $benchmark_path/tests/exclude

	# refer to xfstests-bld/kvm-xfstests/test-appliance/files/root/fs
	# $ ls -d */exclude
	# ext2/exclude  ext3/exclude  ext4/exclude  local/exclude  nfs/exclude  reiserfs/exclude  tmpfs/exclude
	for fs in ext2 ext4
	do
		wget --no-check-certificate -O $benchmark_path/tests/exclude/$fs https://git.kernel.org/pub/scm/fs/ext2/xfstests-bld.git/plain/test-appliance/files/root/fs/$fs/exclude || return
	done

	# In xfstests-dev/tests/generic/605 generic/606 generic/607 generic/608 mount options is "dax=always"
	# _require_scratch_dax_mountopt "dax=always"
	# ext2 do not support -o dax=always, so ignore these test cases
	cd $benchmark_path/tests
	grep "dax=always" generic -R | cut -d':' -f1 | sort -u >> $benchmark_path/tests/exclude/ext2
	cd -

	# cifs exclude files, https://wiki.samba.org/index.php/Xfstesting-cifs
	wget https://wiki.samba.org/images/d/db/Xfstests.exclude.very-slow.txt -O $benchmark_path/tests/cifs/exclude.very-slow.txt || return
	wget https://wiki.samba.org/images/b/b0/Xfstests.exclude.incompatible-smb3.txt -O $benchmark_path/tests/cifs/exclude.incompatible-smb3.txt || return
	wget https://wiki.samba.org/images/9/9f/Xfstests.exclude.incompatible-smb2.txt -O $benchmark_path/tests/cifs/exclude.incompatible-smb2.txt || return

	# download cifs config file
	wget https://wiki.samba.org/images/9/99/Xfstests.local.config.txt -O $benchmark_path/cifs-local.config
}

hide()
{
	mv $1 .$1
}

collect()
{
	grep -l "$1" -r tests/$2 | cut -d/ -f3 | grep -v -f <(cat $benchmark_path/tests/$2-*) | sort
}

generate_special_require_tests()
{
	benchmark_path="${pkgdir}/lkp/benchmarks/${pkgname}"
	cd ${srcdir}/xfstests-dev || return

	for fs in generic ext4 udf ocfs2 nfs btrfs xfs overlay shared ceph f2fs perf cifs
	do
		# "006 dangerous_fuzzers" in tests/ext4/group.list => "006" in ext4-dangerous_fuzzers
		# "054 auto quick dangerous_fuzzers" in tests/ext4/group.list => "054" in ext4-dangerous_fuzzers
		grep "dangerous_fuzzers" tests/$fs/group.list | cut -d' ' -f1 > $benchmark_path/tests/$fs-dangerous_fuzzers
	done

	collect _require_no_xfs_bug_on_assert generic > $benchmark_path/tests/generic-no-bug-on-assert
	collect _require_no_xfs_bug_on_assert xfs > $benchmark_path/tests/xfs-no-bug-on-assert

	collect _require_xfs_stress_online_repair xfs > $benchmark_path/tests/xfs-stress-online-repair
	collect _require_xfs_stress_scrub xfs > $benchmark_path/tests/xfs-stress-scrub

	collect _require_realtime xfs > $benchmark_path/tests/xfs-realtime
	git grep -L "_require_realtime" $(git grep -l "_require_scratch_reflink" $(git grep -l "_require_xfs_scratch_rmapbt" | grep tests/xfs))  | awk -F/ '{print $3}' | grep -v -f <(cat $benchmark_path/tests/xfs-*) > $benchmark_path/tests/xfs-reflink-rmapbt
	git grep -L "_require_realtime" $(git grep -L "_require_scratch_reflink" $(git grep -l "_require_xfs_scratch_rmapbt" | grep tests/xfs))  | awk -F/ '{print $3}' | grep -v -f <(cat $benchmark_path/tests/xfs-*) > $benchmark_path/tests/xfs-rmapbt
	collect _require_scratch_reflink xfs > $benchmark_path/tests/xfs-scratch-reflink

	collect _require_scratch_reflink generic > $benchmark_path/tests/generic-scratch-reflink

	# run slowly on udf
	collect "holetest" generic > $benchmark_path/tests/generic-holetest

	# require CONFIG_FS_VERITY
	collect _require_scratch_verity generic > $benchmark_path/tests/generic-scratch-verity
	collect _require_scratch_verity btrfs > $benchmark_path/tests/btrfs-scratch-verity

	# these tests requires a valid $LOGWRITES_DEV
	# rli9 FIXME consider other fs that has this requirement
	collect "_require_log_writes$" btrfs > $benchmark_path/tests/btrfs-logwrites
	collect "_require_log_writes$" generic > $benchmark_path/tests/generic-logwrites

	# [not run] cifs does not support NFS export
	collect _require_exportfs generic > $benchmark_path/tests/generic-exportfs

	# [not run] duperemove does not support file system type: ext2
	collect _require_scratch_duperemove generic > $benchmark_path/tests/generic-scratch-duperemove

	# these tests requires a valid $SCRATCH_LOGDEV
	for fs in generic ext4 xfs
	do
		collect "_require_logdev$" $fs > $benchmark_path/tests/$fs-logdev
	done

	# [not run] btrfs/ext2/udf does not support shutdown
	collect "_require_scratch_shutdown$" generic > $benchmark_path/tests/generic-scratch-shutdown
	# [not run] ext2/udf does not support metadata journaling
	collect _require_metadata_journaling generic > $benchmark_path/tests/generic-metadata-journaling

	# [not run] vfstest not support by cifs/ext2/udf
	collect _require_idmapped_mounts generic > $benchmark_path/tests/generic-idmapped-mounts

	# [not run] udf does not support freezing
	collect _require_freeze generic > $benchmark_path/tests/generic-freeze

	# these tests require -o dax support
	for fs in generic ext4
	do
		grep "dax" tests/$fs/group.list | cut -d' ' -f1 > $benchmark_path/tests/$fs-dax
	done
}

build()
{
	benchmark_path="${pkgdir}/lkp/benchmarks/${pkgname}"
	mkdir -p ${benchmark_path}/tests

	cd $srcdir
	build_install_xfstests || return
	build_install_f2fs_tools || return
	build_install_e2fuzz
}

package()
{
	benchmark_path="${pkgdir}/lkp/benchmarks/${pkgname}"
	cp -af $srcdir/xfstests-dev/* $benchmark_path

	wget --no-check-certificate -O $benchmark_path/tools/find-api-violations.sh https://git.kernel.org/pub/scm/fs/xfs/xfsprogs-dev.git/plain/tools/find-api-violations.sh || return

	generate_exclude_files || return

	generate_tests || return

	split_tests
}

generate_tests()
{
	benchmark_path="${pkgdir}/lkp/benchmarks/${pkgname}"

	for tests in $(get_pkg_dir $pkgname)/addon/tests/*
	do
		cat $tests | grep -v '^#' > $benchmark_path/tests/$(basename $tests)
	done

	generate_special_require_tests || return

	# generate the new add subcase automatically after every upgrade xfstests
	cd $benchmark_path/tests

	$LKP_SRC/tools/generate-tests ext4
	$LKP_SRC/tools/generate-tests btrfs
	$LKP_SRC/tools/generate-tests xfs
	$LKP_SRC/tools/generate-tests generic
	$LKP_SRC/tools/generate-tests udf
	$LKP_SRC/tools/generate-tests ocfs2
	$LKP_SRC/tools/generate-tests cifs
}

# Some files contain too many tests, which are split for easy testing
split_tests()
{
	benchmark_path="${pkgdir}/lkp/benchmarks/${pkgname}"

	cd $benchmark_path/tests
	split_standalone_tests || return

	$LKP_SRC/tools/split-tests xfs-all 10 xfs-group-
	$LKP_SRC/tools/split-tests btrfs-all 10 btrfs-group-
	$LKP_SRC/tools/split-tests generic-all 10 generic-group-
	$LKP_SRC/tools/split-tests ext4-all 20 ext4-group-
	$LKP_SRC/tools/split-tests udf-all 10 udf-group-
	$LKP_SRC/tools/split-tests ocfs2-all 10 ocfs2-group-

	$LKP_SRC/tools/split-tests xfs-scratch-reflink 20 xfs-scratch-reflink-
	hide xfs-scratch-reflink
}

# Some special tests need to be separated and tested separately
split_standalone_tests()
{
	# These special tests are written in the relevant files under LKP-SRC/pack/xfstests-addon/tests
	for file in *-standalone
	do
		fields=(`echo $file | tr '-' ' '`)
		fs=${fields[0]}

		tests=$(cat $file)
		for test in ${tests[@]}
		do
			echo $test >> ./$fs-$test
		done
	done
}
